[![Build Status](https://travis-ci.org/AdamVig/stockpile-api.svg?branch=master)](https://travis-ci.org/AdamVig/stockpile-api)
[![Coverage Status](https://coveralls.io/repos/github/AdamVig/stockpile-api/badge.svg)](https://coveralls.io/github/AdamVig/stockpile-api)
[![Code Climate](https://codeclimate.com/github/AdamVig/stockpile-api/badges/gpa.svg)](https://codeclimate.com/github/AdamVig/stockpile-api)

# stockpile-api
The API for Stockpile, an app that manages stuff for organizations.  

See [stockpile-app](https://github.com/emmanuelroussel/stockpile-app) for the web and mobile application that consumes this API.  

## Scripts
Yarn presents the same API as npm for running scripts. The scripts below are defined in `package.json`.  
 * `yarn start` start the app in production
 * `yarn stop` stop the app in production
 * `yarn test` test code using [Ava](https://github.com/avajs/ava)
 * `yarn run dev` run the app in development
 * `yarn run lint` lint code using [ESLint](http://eslint.org/) + [StandardJS](http://standardjs.com/)
 * `yarn run docs` generate documentation using [Docco](https://jashkenas.github.io/docco/)

## Environment Variables
You must define environment variables in a `.env` file in the root directory of the project. Use `.env.example` as a template. The app will fail to start if any of the variables in `.env.example` are undefined.  
Environment variables are loaded into the app and can be accessed in any file with `process.env.VAR_NAME`.  
Override variables at run-time by defining them with the command, like `VAR_NAME=value yarn start`.  

## Tests
Tests are located in `./test` and are run asynchronously in parallel with `yarn test`.  

## Documentation
Documentation is located in `./docco` and is generated by running `yarn run docs`. Any comments beginning with a `//` will be considered "prose" and formatted as text alongside the source code in the documentation.  

A specific file's documentation can be found in the generated HTML file with the same name.  

## Deploying
Deployments are made directly from the master branch using Travis CI. Commits to master should be made only via merged pull requests.  

Every pull request must increment the version in `package.json` and contain an up-to-date build of the documentation.  

## Adding New Routes
All route logic is contained in controllers representing individual endpoints. Each controller should contain all of the relevant actions for an endpoint. Example controller:  
```JavaScript
// controllers/example.js
module.exports.get = (req, res, next) => {
  try {
    res.send('example')
  } catch (err) {
    next(err)
  }
}
```

Controller exports should be named for what they *do* not what HTTP verb they will be associated with. For example, use `module.exports.update` instead of `module.exports.put`.  


Routes are defined in `./controllers/routes.js`. Example of defining a route:  
```JavaScript
// controllers/routes.js
const example = require('./example')

module.exports = (app) => {
  app.get({name: 'get example', path: '/example'}, example.get)
}
```

Each route *must* have a descriptive, unique `name` property. Route names are used in defining relations, which show up in the `_links` property of responses. Restify removes spaces, special characters, and uppercase letters from route names, so there is no need to camelcase or kebab-case them.  

## API Documentation
*This section of the README will serve as documentation for the API until a permanent solution is set up.*
### Authenticating
When the organization does not exist yet:  
`POST /register` with body containing:
```JSON
{"name": "Name of Organization", "email": "org@example.com", "password": "org123"}
```

When the organization already exists:  
`POST /auth` with body containing:
```JSON
{"email": "org@example.com", "password": "org123"}
```

In either situation, you will receive a response like this:  
```JSON
{"id": 1, "token": "987234.sdf0982347234.hjgsdf89234", "message": "organization credentials are valid"}
```

Make all further requests with the following header:  
`Authorization: Bearer 987234.sdf0982347234.hjgsdf89234`

### Filtering Items
To filter items by brand, category, or model, use the following query parameter syntax:  
```
/items?brandID=1&modelID=1&categoryID=1&available=0
/items?brandID=3
/items?modelID=5
/items?categoryID=18
/items?available=0
```

The values of the query parameters ending in `ID` are the IDs of the entities they specify in the database. The value of the `available` parameter is a boolean (`0` or `1`) representing whether the items returned should be available or not.  
